# Домашняя работа №8

## Minio. S3

### Если вдруг проспал, на семинаре было
1. Что такое S3, в каких случаях применяется?
2. Бакеты и объекты - что это и чем отличаются?
3. Что такое Minio, зачем он нужен и с чем его едят?
4. Преимущества использования Minio.
5. Вводная про S3

### Теория
1. [Полная статья по настройке и использованию Minio с примерами на Go](https://habr.com/ru/companies/ozontech/articles/586024/)
2. [Официальная документация по использованию Minio с .NET](https://min.io/docs/minio/linux/developers/dotnet/minio-dotnet.html)
3. [Про S3 хранилища](https://habr.com/ru/companies/cloud4y/articles/681376/)

### Вопросы к семинару
1. Что такое бакет? Бакет == папка/директория?
2. Расшифруйте S3. Объясните суть этого термина. Что значит S3-совместимое хранилище? Почему все облачные хранилища стараются делать S3-совместимыми?
3. Зачем использовать Minio, когда есть AWS S3? (ответ: потому что AWS ушли из России - не принимается)
4. Какие варианты использования S3-совместимых хранилищ вы можете назвать?
5. Зачем использовать S3, если можно просто хранить blob-ы в бд? В каких случаях релевантно использовать S3, а в каких бд?
6. Как добиться имитации древовидной структуры хранилища объектов в S3?
7. Знаете ли вы какие-нибудь другие S3-совместимые хранилища? Чем Minio выделяется среди себе подобных?
8. Как вы считаете, S3 - это полноценная удалённая файловая система или скорее простое key-value хранилище объектов?
9. Расскажите коротко про управление контролем доступа к S3 бакетам и объектам

### Домашка
1. Настроить Dockerfile для проекта Storage.API, обновить docker-compose.yml (билд Storage.API должен происходить через созданный Dockerfile).
2. Правильно настроить Minio в docker-compose.yml. Авторизация по логину-паролю minioadmin-minioadmin не должна проходить, т.е. нужно поменять дефолтные данные авторизации на какие-нибудь свои.
3. В environment переменные через докер добавить все необходимые поля для десериализации Storage.API/MinioConfig.cs.
4. Имплементировать ServicesExtensions/AddMinioExtension, StorageFactory, ImageStorage и PendingObjectsProcessor. Фабрика должна возвращать ImageStorage, который должен _'знать'_ бакет, в котором он работает. В приложении должен работать только один экземпляр MinioClient. Логика работы выгрузки файлов в Minio должна быть следующей: вначале каждый объект попадает в бакет с названием Constants.Buckets.Pending. Затем в какой-то момент все файлы, которые находятся в этом бакете, обрабатывает background service PendingObjectsProcessor и перемещает в нужное место*, очищая при этом PendingBucket. Этот background service должен запускаться раз в Constants/PendingObjectProcessor.Period.
5. За вас уже написаны эндпоинты в Storage.API/Endpoints. Вам нужно лишь написать правильную реализацию сервисов и проверить, что всё работает как нужно (объекты корректно создаются, получаются, удаляются и выводятся).
6. **ВНИМАНИЕ**: некоторые тесты перед прогоном запускают процесс ОС с разворачиванием докер-контейнера с сервером Minio. Необходимо, чтобы Docker Engine работал на компьютере во время прогона тестов (и желательно, иметь скачанный образ minio/minio:latest до первого прогона тестов). Также следует быть очень внимательным: если тесты завершают свою работу не в штатном режиме (например, вы их останавливаете во время работы вручную), процесс с докер-контейнером Minio может продолжить работать. Вам необходимо его остановить и удалить, если такое случилось. Если же тестирование завершилось в штатном режиме (пусть некоторые тесты и не прошли), то контейнер остановится и удалится самостоятельно, вам не следует о нём беспокоиться. Также если некоторые тесты отвалились с ошибкой, связанной с подключением MinioClient, то попробуйте просто их перезапустить. Такое случается редко и непонятно почему. 
7. Если порт, используемый для разворачивания докер-контейнера в тестах, уже занят (вам сообщат об этом тесты), поменяйте порт в Dotnet.Homeworks.Tests/MinioStorage/Helpers/TestEnvironmentMinioInstance.cs и попробуйте снова.

_* Подсказка, как сохранить информацию о том, куда следует переместить объект из PendingBucket: у каждого объекта есть метаданные - Dictionary<string, string>, куда можно записать дополнительную информацию об объекте._